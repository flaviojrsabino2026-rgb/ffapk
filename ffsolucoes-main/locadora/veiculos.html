<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Ve√≠culos | Locadora</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:Arial;background:#020617;color:#fff}
.container{max-width:900px;margin:40px auto;padding:20px}
.box{background:#0f172a;padding:20px;border-radius:16px;margin-bottom:20px}
input,button{width:100%;padding:14px;margin-top:10px;border-radius:10px;border:none}
input{background:#020617;color:#fff}
button{background:#22c55e;font-weight:bold;cursor:pointer}
.statusBtns{display:flex;gap:10px;margin-top:10px}
.statusBtns button{flex:1}
.veiculo{background:#020617;padding:14px;border-radius:12px;margin-top:12px;display:flex;gap:12px}
.veiculo img{width:120px;height:80px;object-fit:cover;border-radius:8px}
.actions button{margin-top:6px;background:#334155}
.actions .del{background:#ef4444}
</style>
</head>

<body>

<div class="container">

  <div class="box">
    <h2>üöó Cadastrar Ve√≠culo</h2>

    <input id="modelo" placeholder="Modelo">
    <input id="diaria" type="number" placeholder="Di√°ria">

    <div class="statusBtns">
      <button type="button" onclick="setStatus('disponivel')" style="background:#22c55e">
        Dispon√≠vel
      </button>
      <button type="button" onclick="setStatus('alugado')" style="background:#ef4444">
        Alugado
      </button>
    </div>

    <input id="status" type="hidden" value="disponivel">
    <input id="dias" type="number" placeholder="Dias alugado" style="display:none">

    <!-- üî• MULTIPLAS FOTOS -->
    <input id="fotos" type="file" accept="image/*" multiple>

    <button onclick="cadastrarVeiculo()">Cadastrar Ve√≠culo</button>
  </div>

  <div class="box">
    <h2>üìã Ve√≠culos cadastrados</h2>
    <div id="lista"></div>
  </div>

</div>

<script>
/* üîå SUPABASE */
const db = window._supabase ??= supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

/* üîê ADMIN */
const admin = JSON.parse(localStorage.getItem("admin_logado"));
if (!admin || !admin.app_id) {
  alert("Locadora n√£o selecionada");
  throw new Error("sem app_id");
}

/* üö¶ STATUS */
function setStatus(valor){
  document.getElementById("status").value = valor;
  document.getElementById("dias").style.display =
    valor === "alugado" ? "block" : "none";
}

/* üì∏ UPLOAD MULTIPLO */
async function uploadFotos(files){
  const urls = [];
  for(const file of files){
    const nome = `${Date.now()}_${file.name}`;
    await db.storage.from("veiculos").upload(nome, file);
    const url = db.storage.from("veiculos").getPublicUrl(nome).data.publicUrl;
    urls.push(url);
  }
  return urls;
}

/* ‚ûï CADASTRAR */
async function cadastrarVeiculo(){
  const modelo = document.getElementById("modelo").value.trim();
  const diaria = Number(document.getElementById("diaria").value);
  const status = document.getElementById("status").value;
  const dias = Number(document.getElementById("dias").value) || null;
  const files = document.getElementById("fotos").files;

  if(!modelo || !diaria){
    alert("Preencha tudo");
    return;
  }

  const fotos = await uploadFotos(files);
  const foto_url = fotos[0] || null;

  const data_fim = status === "alugado" && dias
    ? new Date(Date.now() + dias * 86400000).toISOString().split("T")[0]
    : null;

  await db.from("veiculos").insert({
    app_id: admin.app_id,
    modelo,
    diaria,
    status,
    dias_alugado: dias,
    data_fim,
    foto_url,
    fotos
  });

  document.getElementById("modelo").value = "";
  document.getElementById("diaria").value = "";
  document.getElementById("dias").value = "";
  document.getElementById("fotos").value = "";
  setStatus("disponivel");

  carregarVeiculos();
}

/* üìã LISTAR */
async function carregarVeiculos(){
  const { data } = await db
    .from("veiculos")
    .select("*")
    .eq("app_id", admin.app_id)
    .order("created_at",{ascending:false});

  const lista = document.getElementById("lista");
  lista.innerHTML = "";

  data.forEach(v=>{
    const capa = v.foto_url || v.fotos?.[0] || "";
    lista.innerHTML += `
      <div class="veiculo">
        ${capa ? `<img src="${capa}">` : ""}
        <div>
          <b>${v.modelo}</b><br>
          Di√°ria: R$ ${v.diaria}<br>
          Status: ${v.status}<br>
          ${v.status==="alugado" && v.data_fim ? `At√©: ${new Date(v.data_fim+"T00:00:00").toLocaleDateString()}` : ""}
          <div class="actions">
            <button onclick="toggleStatus('${v.id}','${v.status}','${v.modelo}',${v.diaria})">
              ${v.status==="disponivel"?"Marcar alugado":"Marcar dispon√≠vel"}
            </button>
            <button class="del" onclick="excluir('${v.id}')">Excluir</button>
          </div>
        </div>
      </div>
    `;
  });
}

/* üîÅ STATUS + LOCA√á√ÉO */
async function toggleStatus(id,status,modelo,diaria){

  if(status === "disponivel"){
    const nome = prompt("Nome do cliente:");
    if(!nome) return;

    const telefone = prompt("Telefone:");
    if(!telefone) return;

    const dias = Number(prompt("Quantos dias?"));
    if(!dias || dias <= 0) return;

    const total = dias * diaria;
    const fim = new Date();
    fim.setDate(fim.getDate() + dias);

    await db.from("locacoes").insert({
      app_id: admin.app_id,
      nome,
      telefone,
      veiculo: modelo,
      diaria,
      dias,
      total,
      status:"ativa"
    });

    await db.from("veiculos").update({
      status:"alugado",
      dias_alugado:dias,
      data_fim:fim.toISOString().split("T")[0]
    }).eq("id",id);

  }else{
    if(!confirm("Finalizar loca√ß√£o?")) return;

    await db.from("locacoes")
      .update({status:"finalizada"})
      .eq("veiculo",modelo)
      .eq("status","ativa");

    await db.from("veiculos").update({
      status:"disponivel",
      dias_alugado:null,
      data_fim:null
    }).eq("id",id);
  }

  carregarVeiculos();
}

/* üóëÔ∏è EXCLUIR */
async function excluir(id){
  if(!confirm("Excluir ve√≠culo?")) return;
  await db.from("veiculos").delete().eq("id",id);
  carregarVeiculos();
}

carregarVeiculos();
</script>

</body>
</html>
