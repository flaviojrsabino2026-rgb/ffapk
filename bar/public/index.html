<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>CardÃ¡pio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --primary:#8b5e3c;
  --bg:#f6f1eb;
  --card:#ffffff;
  --text:#2e1f14;
  --border:#e6ded5;
}
*{box-sizing:border-box;}
body{margin:0;font-family:system-ui;background:var(--bg);color:var(--text);}
.topo{height:220px;display:flex;align-items:center;justify-content:center;position:relative}
.banner{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
.topo::after{content:"";position:absolute;inset:0;background:rgba(0,0,0,.35)}
.topo-conteudo{position:relative;color:#fff;text-align:center}
.logo{max-height:70px;margin-bottom:10px}
.container{max-width:1100px;margin:auto;padding:20px 16px 140px;display:grid;gap:16px}
.produto{background:#fff;border-radius:16px;padding:14px;display:flex;gap:12px;border:1px solid var(--border)}
.add-btn{width:42px;height:42px;border-radius:50%;border:none;background:var(--primary);color:#fff;font-size:22px;font-weight:900}
.carrinho-btn{position:fixed;bottom:22px;left:50%;transform:translateX(-50%);background:var(--primary);color:#fff;padding:16px 30px;border-radius:999px;font-weight:900}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:flex-end}
.modal-content{background:#fff;width:100%;max-width:520px;margin:auto;border-radius:26px 26px 0 0;padding:26px}
input,button{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);margin-bottom:12px}
button{background:var(--primary);color:#fff;font-weight:900;border:none}
</style>
</head>

<body>

<div class="topo">
  <img id="banner" class="banner" style="display:none">
  <div class="topo-conteudo">
    <img id="logo" class="logo" style="display:none">
    <h1 id="nome">CardÃ¡pio</h1>
  </div>
</div>

<div class="container" id="conteudo"></div>

<div class="carrinho-btn" onclick="abrirCarrinho()">
  ðŸ›’ Ver pedido (<span id="qtd">0</span>)
</div>

<div class="modal" id="modal">
  <div class="modal-content">
    <h3>ðŸ§¾ Seu pedido</h3>
    <input id="cliente_nome" placeholder="Seu nome">
    <input id="cliente_whatsapp" placeholder="WhatsApp (DDD + nÃºmero)">
    <input id="cliente_endereco" placeholder="Bairro / referÃªncia">
    <div id="lista"></div>
    <button onclick="enviarPedido()">Enviar pedido</button>
  </div>
</div>

<script>
/* ================= SUPABASE ================= */
const sb = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

/* ================= PARAMS ================= */
const params = new URLSearchParams(location.search);
const app_id = params.get("app_id") || localStorage.getItem("app_id");
if(!app_id){ document.body.innerHTML="IndisponÃ­vel"; throw ""; }
localStorage.setItem("app_id", app_id);

/* ================= STATE ================= */
let produtos = [];
let carrinho = [];
let enviando = false;

/* ================= HELPERS ================= */
function celularValido(num){
  return /^\d{10,11}$/.test(num.replace(/\D/g,""));
}

/* ================= CARRINHO ================= */
function salvarCarrinho(){
  localStorage.setItem("carrinho_"+app_id, JSON.stringify(carrinho));
}
function carregarCarrinho(){
  const salvo = localStorage.getItem("carrinho_"+app_id);
  if(salvo){
    carrinho = JSON.parse(salvo);
    qtd.innerText = carrinho.reduce((s,i)=>s+i.qtd,0);
  }
}

/* ================= CONFIG ================= */
async function carregarConfig(){
  const { data } = await sb
    .from("config_site")
    .select("*")
    .eq("app_id", app_id)
    .single();

  if(!data) return;
  nome.innerText = data.nome_site || "CardÃ¡pio";
  if(data.logo_url){ logo.src=data.logo_url; logo.style.display="block"; }
  if(data.banner_url){ banner.src=data.banner_url; banner.style.display="block"; }
}

/* ================= PRODUTOS ================= */
async function carregarProdutos(){
  const { data } = await sb
    .from("produtos")
    .select("id,nome,preco,foto")
    .eq("app_id", app_id)
    .eq("ativo", true)
    .order("nome");

  produtos = data || [];
  conteudo.innerHTML = "";

  produtos.forEach(p=>{
    conteudo.innerHTML += `
      <div class="produto">
        ${p.foto?`<img src="${p.foto}" width="80">`:""}
        <div style="flex:1">
          <b>${p.nome}</b><br>
          R$ ${p.preco.toFixed(2)}
        </div>
        <button class="add-btn" onclick="addProduto('${p.id}')">+</button>
      </div>
    `;
  });
}

/* ================= ADD PRODUTO ================= */
function addProduto(id){
  const p = produtos.find(x=>x.id===id);

  if(carrinho.length > 0){
    const ok = confirm(
      `Adicionar mais um item ao pedido?\n\n${p.nome}\nR$ ${p.preco.toFixed(2)}`
    );
    if(!ok) return;
  }

  const i = carrinho.find(x=>x.id===id);
  i ? i.qtd++ : carrinho.push({ ...p, qtd:1 });

  qtd.innerText = carrinho.reduce((s,i)=>s+i.qtd,0);
  salvarCarrinho();
}

/* ================= MODAL ================= */
function abrirCarrinho(){
  modal.style.display="flex";
  lista.innerHTML="";
  let total = 0;

  carrinho.forEach(i=>{
    total += i.preco * i.qtd;
    lista.innerHTML += `
      <div style="display:flex;justify-content:space-between">
        <span>${i.qtd}x ${i.nome}</span>
        <b>R$ ${(i.preco*i.qtd).toFixed(2)}</b>
      </div>
    `;
  });

  lista.innerHTML += `
    <hr>
    <div style="display:flex;justify-content:space-between;font-size:18px">
      <b>Total</b>
      <b>R$ ${total.toFixed(2)}</b>
    </div>
  `;
}

/* ================= ENVIAR PEDIDO ================= */
async function enviarPedido(){
  if(enviando) return;
  enviando = true;

  try{
    if(carrinho.length===0){ alert("Carrinho vazio"); return; }

    const nomeCli = cliente_nome.value.trim();
    const celular = cliente_whatsapp.value.trim();

    if(!nomeCli){ alert("Informe seu nome"); return; }
    if(!celularValido(celular)){ alert("WhatsApp invÃ¡lido"); return; }

    // ðŸ”¥ AJUSTE PRINCIPAL AQUI
    const { data: pedidoAberto } = await sb
      .from("pedidos")
      .select("id")
      .eq("app_id", app_id)
      .eq("cliente_whatsapp", celular)
      .in("status", ["aberto","aceito"])
      .maybeSingle();

    let pedidoId = pedidoAberto?.id || null;

    if(pedidoId){
      const ok = confirm(
        "VocÃª jÃ¡ tem um pedido em andamento.\nDeseja adicionar mais itens nele?"
      );
      if(!ok) return;
    }

    if(!pedidoId){
      const { data: pedido } = await sb
        .from("pedidos")
        .insert({
          app_id,
          origem:"web",
          cliente_nome:nomeCli,
          cliente_whatsapp:celular,
          cliente_endereco:cliente_endereco.value || null,
          status:"aberto",
          atendido:false
        })
        .select("id")
        .single();

      pedidoId = pedido.id;
    }

    for(const i of carrinho){
      await sb.from("pedido_itens").insert({
        app_id,
        pedido_id:pedidoId,
        produto_id:i.id,
        nome_produto:i.nome,
        preco:i.preco,
        quantidade:i.qtd
      });
    }

    ouvirPedido(pedidoId);

    alert("Pedido enviado â˜•");
    carrinho=[];
    localStorage.removeItem("carrinho_"+app_id);
    qtd.innerText=0;
    modal.style.display="none";

  } finally {
    enviando=false;
  }
}

/* ================= REALTIME + WHATS ================= */
function ouvirPedido(pedidoId){
  sb.channel("pedido-"+pedidoId)
    .on("postgres_changes",{
      event:"UPDATE",
      schema:"public",
      table:"pedidos",
      filter:`id=eq.${pedidoId}`
    }, async payload=>{
      if(payload.new.status==="aceito"){
        const { data: itens } = await sb
          .from("pedido_itens")
          .select("nome_produto,quantidade,preco")
          .eq("pedido_id", pedidoId);

        let msg="âœ… Pedido aceito!\n\nðŸ§¾ Resumo:\n";
        let total=0;

        itens.forEach(i=>{
          const sub=i.preco*i.quantidade;
          total+=sub;
          msg+=`â€¢ ${i.quantidade}x ${i.nome_produto} â€” R$ ${sub.toFixed(2)}\n`;
        });

        msg+=`\nðŸ’° Total: R$ ${total.toFixed(2)}\n\nObrigado pelo pedido â˜•`;

        const num = payload.new.cliente_whatsapp.replace(/\D/g,"");
        window.open(`https://wa.me/55${num}?text=${encodeURIComponent(msg)}`);
      }

      if(payload.new.status==="finalizado"){
        alert("ðŸ” Pedido finalizado!");
      }
    }).subscribe();
}

/* ================= START ================= */
modal.onclick = e=> e.target===modal && (modal.style.display="none");

(async()=>{
  await carregarConfig();
  await carregarProdutos();
  carregarCarrinho();
})();
</script>

</body>
</html>
