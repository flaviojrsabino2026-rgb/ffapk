<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Hist√≥rico de Vendas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  margin:0;
  font-family:Arial,sans-serif;
  background:#020617;
  color:#fff;
}
.topo{
  background:#0f172a;
  padding:16px 24px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.container{
  max-width:1200px;
  margin:auto;
  padding:24px;
}
.card{
  background:#0f172a;
  border-radius:18px;
  padding:18px;
  margin-bottom:18px;
}
.top{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
}
.mesa{
  font-size:18px;
  font-weight:bold;
}
.total{
  font-size:20px;
  font-weight:900;
}
.itens{
  margin-top:12px;
}
.item{
  display:flex;
  justify-content:space-between;
  padding:6px 0;
  border-bottom:1px solid #1e293b;
  font-size:14px;
}
small{
  color:#94a3b8;
}
.tag{
  display:inline-block;
  padding:4px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:bold;
  margin-top:6px;
}
.mesa-tag{ background:#2563eb }
.web-tag{ background:#9333ea }
</style>
</head>

<body>

<div class="topo">
  <h2>üìä Hist√≥rico de Vendas</h2>
  <button onclick="history.back()">‚¨Ö Voltar</button>
</div>

<div class="container">
  <div id="lista">Carregando hist√≥rico...</div>
</div>

<script>
/* ================= SUPABASE ================= */
const sb = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

/* ================= SESS√ÉO ================= */
const admin = JSON.parse(localStorage.getItem("admin_logado"));
const funcionario = JSON.parse(localStorage.getItem("funcionario_logado"));
const app_id = funcionario?.app_id || admin?.app_id;

if(!app_id){
  alert("Sess√£o inv√°lida");
  location.href="../auth/login.html";
}

const lista = document.getElementById("lista");

/* ================= CARREGAR HIST√ìRICO ================= */
async function carregarHistorico(){

  const { data, error } = await sb
    .from("pedidos")
    .select(`
      id,
      status,
      created_at,
      recebido_por,
      recebido_em,
      cliente_nome,
      mesa_id,
      mesas ( numero_mesa ),
      pedido_itens (
        nome_produto,
        quantidade,
        preco
      )
    `)
    .eq("app_id", app_id)
    .eq("status", "pago")
    .order("recebido_em", { ascending:false });

  if(error){
    console.error(error);
    lista.innerHTML = "Erro ao carregar hist√≥rico";
    return;
  }

  lista.innerHTML = "";

  if(!data || data.length === 0){
    lista.innerHTML = "<p>Nenhuma venda registrada</p>";
    return;
  }

  data.forEach(p=>{
    let total = 0;
    p.pedido_itens.forEach(i=>{
      total += i.quantidade * i.preco;
    });

    const origemMesa = !!p.mesa_id;

    lista.innerHTML += `
      <div class="card">
        <div class="top">
          <div>
            <div class="mesa">
              ${origemMesa ? `Mesa ${p.mesas.numero_mesa}` : (p.cliente_nome || "Delivery")}
            </div>

            <span class="tag ${origemMesa ? "mesa-tag" : "web-tag"}">
              ${origemMesa ? "MESA" : "DELIVERY"}
            </span>

            <br><br>
            <small>
              Recebido por: <b>${p.recebido_por || "‚Äî"}</b><br>
              ${p.recebido_em
                ? "‚è∞ " + new Date(p.recebido_em).toLocaleString()
                : ""}
            </small>
          </div>

          <div class="total">
            R$ ${total.toFixed(2)}
          </div>
        </div>

        <div class="itens">
          ${p.pedido_itens.map(i=>`
            <div class="item">
              <span>
                ${i.quantidade}x ${i.nome_produto}<br>
                <small>R$ ${i.preco.toFixed(2)} cada</small>
              </span>
              <b>R$ ${(i.quantidade * i.preco).toFixed(2)}</b>
            </div>
          `).join("")}
        </div>
      </div>
    `;
  });
}

/* START */
carregarHistorico();
</script>

</body>
</html>
