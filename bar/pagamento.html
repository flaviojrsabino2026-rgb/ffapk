<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Pagamento</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;font-family:Arial;background:#020617;color:#fff}
.container{max-width:600px;margin:auto;padding:24px}
.card{background:#0f172a;padding:20px;border-radius:16px}
h2{margin-top:0}
select,input,button{
  width:100%;
  padding:14px;
  border-radius:10px;
  border:none;
  margin-top:12px
}
button{background:#22c55e;font-weight:bold;cursor:pointer}
.troco{color:#22c55e;font-weight:bold;margin-top:10px}
</style>
</head>

<body>

<div class="container">
  <div class="card">
    <h2>ðŸ’³ Pagamento</h2>
    <div id="resumo"></div>

    <select id="forma" onchange="ajustarForma()">
      <option value="dinheiro">Dinheiro</option>
      <option value="pix">PIX</option>
      <option value="debito">DÃ©bito</option>
      <option value="credito">CrÃ©dito</option>
    </select>

    <input id="valorPago" type="number" step="0.01" placeholder="Valor pago">

    <div id="troco" class="troco"></div>

    <button onclick="finalizar()">âœ… Finalizar pagamento</button>
  </div>
</div>

<script>
const sb = supabase.createClient(
  "https://pdajixsoowcyhnjwhgpc.supabase.co",
  "sb_publishable_LatlFlcxk6IchHe3RNmfwA_9Oq4EsZw"
);

const params = new URLSearchParams(location.search);
const pedidoId = params.get("pedido");
const app_id = params.get("app_id");

let totalPedido = 0;

async function carregar(){
  const { data: itens } = await sb
    .from("pedido_itens")
    .select("preco,quantidade")
    .eq("pedido_id", pedidoId)
    .eq("app_id", app_id);

  itens.forEach(i=>{
    totalPedido += i.preco * i.quantidade;
  });

  document.getElementById("resumo").innerHTML =
    `<p>Total: <strong>R$ ${totalPedido.toFixed(2)}</strong></p>`;

  document.getElementById("valorPago").value = totalPedido.toFixed(2);
}

function ajustarForma(){
  const forma = document.getElementById("forma").value;
  const input = document.getElementById("valorPago");
  document.getElementById("troco").innerHTML = "";

  if(forma !== "dinheiro"){
    input.value = totalPedido.toFixed(2);
    input.disabled = true;
  } else {
    input.disabled = false;
  }
}

function calcularTroco(){
  const pago = Number(document.getElementById("valorPago").value || 0);
  const troco = pago - totalPedido;

  document.getElementById("troco").innerHTML =
    troco >= 0 ? `Troco: R$ ${troco.toFixed(2)}` : "";
}

document.getElementById("valorPago").addEventListener("input", calcularTroco);

async function finalizar(){
  const forma = document.getElementById("forma").value;
  let pago = Number(document.getElementById("valorPago").value || 0);

  if(forma !== "dinheiro"){
    pago = totalPedido;
  }

  if(pago < totalPedido){
    alert("Valor insuficiente");
    return;
  }

  const troco = forma === "dinheiro" ? pago - totalPedido : 0;

  await sb.from("pagamentos").insert({
    app_id,
    pedido_id: pedidoId,
    tipo: forma,
    valor: totalPedido,
    troco
  });

  await sb.from("pedidos")
    .update({ status:"pago" })
    .eq("id", pedidoId)
    .eq("app_id", app_id);

  alert("Pagamento finalizado");
  location.href = "caixa.html";
}

carregar();
ajustarForma();
</script>

</body>
</html>
